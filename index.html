<!doctype html>
<html lang="ru" data-bs-theme="dark">
<head>
  <meta charset="utf-8">
  <title>CutList JS</title>

  <!-- Важно для айфона -->
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap 5 CSS -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
    crossorigin="anonymous"
  >

  <style>
    body { padding-top: 10px; }
    #sheet_canvas { width: 100%; height: 300px; border:1px solid #555; }

    .card { background-color: #1f1f1f; border-color: #333; }
    .card-header { background-color: #262626; border-bottom-color: #333; }
    .table thead { background-color: #262626; }
    .table-bordered, .table-bordered > :not(caption) > * {
      border-color: #444;
    }

    /* Мобильная адаптация под iPhone */
    @media (max-width: 576px) {
      body { padding-top: 6px; }
      h1.h3 { font-size: 1.3rem; }

      .form-label { font-size: 0.9rem; }
      input.form-control,
      select.form-select {
        font-size: 0.95rem;
        padding: 0.35rem 0.5rem;
      }

      table.table-sm td,
      table.table-sm th {
        padding: 0.25rem;
        font-size: 0.8rem;
      }

      #sheet_canvas { height: 220px; }

      .btn {
        font-size: 0.85rem;
        padding: 0.3rem 0.6rem;
      }
    }
  </style>
</head>
<body class="bg-dark text-light">
  <div class="container-fluid px-2 px-md-4">
    <h1 class="h3 mb-3 text-center">CutList JS</h1>

    <!-- Параметры листа -->
    <div class="card mb-3">
      <div class="card-body row g-2">
        <div class="col-12 col-md-4">
          <label class="form-label">Ширина листа (мм)</label>
          <input id="sheet_width" class="form-control" value="1250">
        </div>
        <div class="col-6 col-md-2">
          <label class="form-label">Толщина реза (мм)</label>
          <input id="kerf" class="form-control" value="0">
        </div>
        <div class="col-12 col-md-6">
          <label class="form-label">Длины листов (мм, через запятую)</label>
          <input id="sheet_lengths" class="form-control" value="3000,2500,2000,1500,1200">
        </div>
      </div>
    </div>

    <!-- Позиции + кнопка расчёта -->
    <div class="card mb-3">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span>Позиции (мм)</span>
        <button class="btn btn-sm btn-primary" onclick="addRow()">Добавить позицию</button>
      </div>
      <div class="card-body p-2">
        <div class="table-responsive">
          <table id="pos_table" class="table table-sm align-middle mb-0 table-bordered">
            <thead>
              <tr>
                <th>Длина</th>
                <th></th>
                <th>Ширина</th>
                <th>Кол-во</th>
                <th style="width:1%;"></th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
      <div class="card-footer text-end">
        <button class="btn btn-success" onclick="calc()">Рассчитать</button>
      </div>
    </div>

    <!-- Визуализация -->
    <div class="row g-3">
      <div class="col-12">
        <div class="card h-100">
          <div class="card-header">
            <label class="form-label me-2 mb-0">Выбери лист:</label>
            <select id="sheet_select"
                    class="form-select form-select-sm d-inline-block w-auto"
                    onchange="drawSelectedSheet()"></select>
          </div>
          <div class="card-body">
            <canvas id="sheet_canvas"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
          integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
          crossorigin="anonymous"></script>

  <script src="cutlogic.js"></script>
  <script>
    let lastResult = null;
    let lastSheetWidth = 1250;

    function addRow(length = "", width = "", count = 1) {
      const tbody = document.querySelector("#pos_table tbody");
      const tr = document.createElement("tr");

      tr.innerHTML = `
        <td>
          <input class="form-control form-control-sm length-input" value="${length}">
        </td>
        <td>
          <select class="form-select form-select-sm length-select">
            <option value="">выбери</option>
            <option value="3000">3000</option>
            <option value="2500">2500</option>
            <option value="2000">2000</option>
            <option value="1500">1500</option>
            <option value="1200">1200</option>
          </select>
        </td>
        <td>
          <input class="form-control form-control-sm" value="${width}">
        </td>
        <td>
          <input class="form-control form-control-sm" value="${count}">
        </td>
        <td>
          <button class="btn btn-sm btn-outline-danger" onclick="this.closest('tr').remove()">×</button>
        </td>
      `;

      tbody.appendChild(tr);

      const select = tr.querySelector(".length-select");
      const inputLen = tr.querySelector(".length-input");
      select.addEventListener("change", () => {
        if (select.value) inputLen.value = select.value;
      });
    }

    function parseFloatSafe(v) {
      const x = parseFloat(String(v).replace(",", "."));
      return isNaN(x) ? null : x;
    }

    function calc() {
      const sheetWidth = parseFloatSafe(document.getElementById("sheet_width").value);
      const kerf = parseFloatSafe(document.getElementById("kerf").value);
      const sheetLengthsStr = document.getElementById("sheet_lengths").value;
      const sheetLengths = sheetLengthsStr.split(",")
        .map(s => parseFloatSafe(s.trim()))
        .filter(x => x && x > 0);

      if (!sheetWidth || sheetWidth <= 0 || kerf === null || sheetLengths.length === 0) {
        alert("Проверь параметры листа.");
        return;
      }

      const rows = document.querySelectorAll("#pos_table tbody tr");
      const positions = [];
      rows.forEach(tr => {
        const lenInput = tr.querySelector(".length-input");
        const inputs = tr.querySelectorAll("input");
        const length = parseFloatSafe(lenInput.value);
        const width  = parseFloatSafe(inputs[1].value);
        const count  = parseInt(inputs[2].value || "0", 10);
        if (length && width && count > 0) {
          positions.push({ length_mm: length, width_mm: width, count: count });
        }
      });

      if (positions.length === 0) {
        alert("Добавь хотя бы одну позицию.");
        return;
      }

      try {
        const res = calculateCutlist(positions, sheetWidth, sheetLengths, kerf);
        lastResult = res;
        lastSheetWidth = sheetWidth;

        const sel = document.getElementById("sheet_select");
        sel.innerHTML = "";
        res.sheets
          .sort((a, b) => a.id - b.id)
          .forEach((sh, idx) => {
            const opt = document.createElement("option");
            opt.value = sh.id;
            opt.textContent = `#${idx+1} длина ${fromUnits(sh.length_u)} мм`;
            sel.appendChild(opt);
          });

        if (res.sheets.length > 0) {
          sel.selectedIndex = 0;
          drawSelectedSheet();
        } else {
          const ctx = document.getElementById("sheet_canvas").getContext("2d");
          ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
        }

      } catch (e) {
        alert("Ошибка: " + e.message);
      }
    }

    function drawSelectedSheet() {
      if (!lastResult || !lastResult.sheets.length) return;
      const sel = document.getElementById("sheet_select");
      if (sel.selectedIndex < 0) return;
      const selectedId = parseInt(sel.value, 10);
      const sheet = lastResult.sheets.find(sh => sh.id === selectedId);
      if (!sheet) return;
      drawSheet(sheet);
    }

    function drawSheet(sheet) {
      const canvas = document.getElementById("sheet_canvas");
      const rect = canvas.getBoundingClientRect();
      canvas.width  = rect.width;
      canvas.height = window.innerWidth <= 576 ? 220 : 300; // ниже на телефоне

      const ctx = canvas.getContext("2d");
      const w = canvas.width;
      const h = canvas.height;

      ctx.clearRect(0, 0, w, h);

      const sheetLen = sheet.length_u / SCALE;  // мм по X
      const sheetW   = lastSheetWidth;          // мм по Y

      const margin = 20;
      const cw = w - 2 * margin;
      const ch = h - 2 * margin;
      if (cw <= 0 || ch <= 0) return;

      const scaleX = cw / sheetLen;
      const scaleY = ch / sheetW;
      const scale = Math.min(scaleX, scaleY);

      const sheetPxW = sheetLen * scale;
      const sheetPxH = sheetW * scale;
      const x0 = (w - sheetPxW) / 2;
      const y0 = (h - sheetPxH) / 2;
      const x1 = x0 + sheetPxW;
      const y1 = y0 + sheetPxH;

      ctx.fillStyle = "#444";
      ctx.strokeStyle = "#ddd";
      ctx.lineWidth = 1;
      ctx.fillRect(x0, y0, sheetPxW, sheetPxH);
      ctx.strokeRect(x0, y0, sheetPxW, sheetPxH);

      ctx.fillStyle = "#fff";
      ctx.textAlign = "center";
      ctx.textBaseline = "bottom";
      ctx.font = window.innerWidth <= 576 ? "13px Arial" : "12px Arial";
      ctx.fillText(
        `Лист ${fromUnits(sheet.length_u)} × ${sheetW.toFixed(1)} мм`,
        (x0 + x1) / 2,
        y0 - 5
      );

      const colors = ["#3b82f6", "#f97316", "#22c55e", "#eab308", "#a855f7", "#06b6d4"];
      let colorIndex = 0;
      let curLenU = 0;

      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.font = window.innerWidth <= 576 ? "11px Arial" : "10px Arial";

      for (const it of sheet.items) {
        const widthU  = it.width_u;
        const lengthU = it.length_u;

        for (let k = 0; k < it.count; k++) {
          const xStartPx = x0 + (curLenU / SCALE) * scale;
          const xEndPx   = x0 + ((curLenU + lengthU) / SCALE) * scale;
          const yStartPx = y0;
          const yEndPx   = y0 + (widthU / SCALE) * scale;

          const color = colors[colorIndex % colors.length];
          colorIndex++;

          ctx.fillStyle = color;
          ctx.strokeStyle = "#111";
          ctx.fillRect(xStartPx, yStartPx, xEndPx - xStartPx, yEndPx - yStartPx);
          ctx.strokeRect(xStartPx, yStartPx, xEndPx - xStartPx, yEndPx - yStartPx);

          const label = `${fromUnits(widthU)}×${fromUnits(lengthU)}`;
          ctx.fillStyle = "#fff";
          ctx.fillText(
            label,
            (xStartPx + xEndPx) / 2,
            (yStartPx + yEndPx) / 2
          );

          curLenU += lengthU;
        }
      }

      const usedLenMm =
        sheet.items.reduce((sum, it) => sum + (it.length_u / SCALE) * it.count, 0);
      if (usedLenMm < sheetLen) {
        const xStartPx = x0 + usedLenMm * scale;
        const xEndPx   = x0 + sheetLen * scale;
        ctx.fillStyle = "#1f2933";
        ctx.strokeStyle = "#555";
        ctx.fillRect(xStartPx, y0, xEndPx - xStartPx, sheetPxH);
        ctx.strokeRect(xStartPx, y0, xEndPx - xStartPx, sheetPxH);

        ctx.fillStyle = "#e5e7eb";
        ctx.fillText(
          "Остаток",
          (xStartPx + xEndPx) / 2,
          (y0 + y1) / 2
        );
      }
    }

    // стартовая строка
    addRow();
  </script>
</body>
</html>
